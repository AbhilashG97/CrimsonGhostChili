# Lesson 2

This is the second lesson that was taught in ```Audi-1's``` sqli tutorial. 

## Other ways to break a query

In the first lesson of sqli labs, we were able to break the query by adding a ```'``` at the end of the query. There are other ways to break the query as well. 

In lesson-3 and lesson-4 of the sqli labs test bed, we can break the query by passing ```"```. In these lessons, when we examine the error carefully we get to know that adding a comment at the end of the statement won't solve the error. This because we are dealing with a user input that is wrapped within quotes and parenthesis. 

The query for lesson-3 and lesson-4 looks somewhat like this - 

```sql
# lesson-3
SELECT * FROM users WHERE id=('$id') LIMIT 0,1; 

# lesson-4
$id = '"' . $id . '"'; 
SELECT * FROM users WHERE id=($id) LIMIT 0,1;
```

This can be solved by adding the messing quote and parenthesis to the url and then following it up with a comment. 

Both lesson-3 and lesson-4 can be solved this way. The answer for the above two looks like this - 

```
http://localhost/sqlilabs/Less-3/?id=1')--+

http://localhost/sqlilabs/Less-4/?id=1")--+
```

Lesson 2 also has something similar. On appending ```1\``` to the query. We get ```''\ LIMIT 0,1'``` as the output. Ignoring the ```'``` at the beginning and at the end of the error statment, we can conclude that the user query is put inside the sql statement as is and the user query is not wrapped around with anything else. The query for lesson-2 looks somewhat like this - 

```sql 
SELECT * FROM users WHERE id=$id LIMIT 0,1
```

This can be exploited directly. More on this in the later section. 

:warning: [This post](https://dba.stackexchange.com/questions/105850/is-there-any-difference-between-limit-0-1-and-limit-1/105858) explains in detail how ```LIMIT``` works in a sql query.

## Finding the number of columns in the query being exploited

If we want to know the number of columns in a query that we are trying to exploit from the url, we can make use of the ```order by``` clause. 

We make use of ```ordinls``` to find out the number of columns. More on this can be found [here](https://stackoverflow.com/questions/3445118/what-is-the-purpose-of-order-by-1-in-sql-select-statement) and [here](https://stackoverflow.com/questions/2253040/benefits-of-using-sql-ordinal-position-notation).

We type in the following url to get obtain the number of column - 

```
http://localhost/sqlilabs/Less-3/?id=1') order by 1--+
```

The number is incremented untill we get an error. In this case, it is 4. 

```
http://localhost/sqlilabs/Less-3/?id=1') order by 4--+
```

We are presented with an error page when the above url is executed. We can conclude that there are 3 columns as an error is thrown when we pass 4. This happens because the query is not able to find the 4th column that we typed in the url. 

## Union based injection 

After we get to know the number of columns in the query that is being exploited, we need to know exactly which column(s) is being used in the vulnerable page. 

We can get this information by making use of the union based injection technique. 

Here we add an additional union-select statement to the query to know which column is being used by the webpage. 

The url will look somewhat like this - 

```
http://localhost//sqlilabs/Less-4/?id=-1") union select 1,2,3 --+
```

:warning: Notice that we added a ```-``` to 1 in the url. This is to show the result of the right part of the union statement. 

On executing the above url, we will notice that 2 and 3 appear on the webpage. This is a major hint that the 2nd and the 3rd column of the query are being executed. This can be further confirmed by replacing 2 and 3 with something else. The corresponding change will be reflected on the webpage. 

## Getting information from the vulnerable query

Now we know that the 2nd and 3rd column of the query is being used in the webpage. We can now get some information from the query. This can be done by replacing 2 and 3 with sql functions. ```version``` and ```database()``` are two such functions. The former tells us about the mysql version whereas the later reveals the name of the database. 

In the end, the url will look somewhat like this - 

```
http://localhost/sqlilabs/Less-4/?id=-1") union select 1,version(),database() --+
```

:exclamation: ```user()``` is another sql function which tells us about the current user.

## :star: Some awesome resources

1. http://www.securityidiots.com/Web-Pentest/SQL-Injection/Basic-Union-Based-SQL-Injection.html
1. https://websec.ca/kb/sql_injection